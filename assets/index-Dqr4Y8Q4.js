(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))l(t);new MutationObserver(t=>{for(const i of t)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&l(s)}).observe(document,{childList:!0,subtree:!0});function a(t){const i={};return t.integrity&&(i.integrity=t.integrity),t.referrerPolicy&&(i.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?i.credentials="include":t.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function l(t){if(t.ep)return;t.ep=!0;const i=a(t);fetch(t.href,i)}})();let c,y,r,o=[],p=!1,f=!1,d=null,u=null,m=null,w=null,g=30,I=null;function S(){if(typeof L>"u"){setTimeout(S,100);return}M(),v(),document.getElementById("btnDraw").onclick=N,document.getElementById("btnFinish").onclick=A,document.getElementById("btnMonitor").onclick=k,document.getElementById("btnReset").onclick=$}document.addEventListener("DOMContentLoaded",S);function M(){c=L.map("map").setView([37.7749,-122.4194],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap"}).addTo(c),c.on("click",P),console.log("Map initialized"),document.getElementById("status").textContent="Map loaded. Requesting GPS location..."}function v(){if(!navigator.geolocation){document.getElementById("coords").textContent="❌ Geolocation not supported",document.getElementById("status").textContent="GPS not available - you can still draw on the map";return}console.log("Requesting location..."),document.getElementById("coords").textContent="⏳ Requesting location permission...",navigator.geolocation.getCurrentPosition(e=>{console.log("Got initial position:",e),h(e),navigator.geolocation.watchPosition(h,C,{enableHighAccuracy:!0,maximumAge:0,timeout:1e4})},e=>{console.error("Initial position error:",e),C(e),navigator.geolocation.watchPosition(h,C,{enableHighAccuracy:!0,maximumAge:5e3,timeout:15e3})},{enableHighAccuracy:!0,maximumAge:0,timeout:5e3})}function h(e){d=e.coords.latitude,u=e.coords.longitude;const n=e.coords.accuracy;console.log("Location update:",d,u,"accuracy:",n),document.getElementById("coords").textContent=`📍 ${d.toFixed(6)}, ${u.toFixed(6)} (±${n.toFixed(0)}m)`,y?y.setLatLng([d,u]):(y=L.marker([d,u]).addTo(c),y.bindPopup("📍 You are here").openPopup(),c.setView([d,u],16)),document.getElementById("status").textContent='GPS tracking active. Click "Start Drawing" to create a boundary.',f&&R(d,u)}function C(e){console.error("Location error:",e);let n="",a="❌ ";switch(e.code){case e.PERMISSION_DENIED:n="🚫 Location permission denied. Please allow location access in your browser settings.",a+="Permission denied";break;case e.POSITION_UNAVAILABLE:n="📡 GPS position unavailable. Make sure GPS is enabled on your device.",a+="Position unavailable";break;case e.TIMEOUT:n="⏱️ Location request timed out. Retrying...",a+="Timeout (retrying...)";break;default:n=`⚠️ Location error: ${e.message}`,a+=e.message}document.getElementById("coords").textContent=a,document.getElementById("status").textContent=n+" You can still draw manually on the map."}function P(e){if(!p)return;const n=[e.latlng.lat,e.latlng.lng];o.push(n),L.circleMarker(e.latlng,{radius:5,fillColor:"#667eea",color:"#667eea",weight:2,fillOpacity:.8}).addTo(c),o.length>1&&L.polyline(o,{color:"#667eea",weight:2}).addTo(c),document.getElementById("status").textContent=`${o.length} point${o.length>1?"s":""} added`}function N(){p=!0,o=[],r&&(c.removeLayer(r),r=null),document.getElementById("btnDraw").disabled=!0,document.getElementById("btnFinish").disabled=!1,document.getElementById("btnMonitor").disabled=!0,document.getElementById("status").textContent="Click on map to add boundary points (minimum 4)"}function A(){if(o.length<4){alert("You need at least 4 points to create a boundary!");return}p=!1,c.eachLayer(e=>{(e instanceof L.CircleMarker||e instanceof L.Polyline)&&c.removeLayer(e)}),r=L.polygon(o,{color:"#4caf50",fillColor:"#4caf50",fillOpacity:.2,weight:2}).addTo(c),document.getElementById("btnDraw").disabled=!1,document.getElementById("btnFinish").disabled=!0,document.getElementById("btnMonitor").disabled=!1,document.getElementById("status").textContent="Boundary created! Ready to start monitoring."}function k(){if(!r){alert("Please create a boundary first!");return}if(f=!0,d&&u){const e=L.latLng(d,u);m=O(e,o),console.log("Starting monitoring. Initial position:",m?"INSIDE":"OUTSIDE","boundary")}else m=null;r.setStyle({color:"#f44336",fillColor:"#f44336"}),document.getElementById("btnDraw").disabled=!0,document.getElementById("btnMonitor").disabled=!0,document.getElementById("status").textContent="🔴 MONITORING ACTIVE - Tracking your location in real-time..."}function R(e,n){if(!r||!f)return;const a=L.latLng(e,n),l=O(a,o);if(console.log("Checking boundary:",{inside:l,wasInside:m,lat:e,lng:n}),m!==null&&m!==l&&(console.log("BOUNDARY CROSSING DETECTED! Was:",m?"INSIDE":"OUTSIDE","→ Now:",l?"INSIDE":"OUTSIDE"),l?(console.log("Device RE-ENTERED boundary - stopping countdown"),r.setStyle({color:"#00ff00",fillColor:"#00ff00",fillOpacity:.3}),E(),alert("✅ SAFE! Device has re-entered the boundary. Wipe has been cancelled!"),document.getElementById("status").textContent="✅ BACK INSIDE - Wipe cancelled, device is safe"):(console.log("Device LEFT boundary - starting countdown"),r.setStyle({color:"#ff0000",fillColor:"#ff0000",fillOpacity:.3}),alert("⚠️ ALERT! Your device has left the boundary and will be wiped clean in 30 seconds!"),F())),l){const t=B(e,n).toFixed(0);document.getElementById("status").textContent=`✅ Inside boundary - ${t}m from edge`}else if(w){const t=B(e,n).toFixed(0);document.getElementById("status").textContent=`🚨 OUTSIDE BOUNDARY - WIPE IN ${g} SECONDS! Re-enter now! (${t}m from edge)`}else{const t=B(e,n).toFixed(0);document.getElementById("status").textContent=`🚨 Outside boundary - ${t}m from edge`}m=l}function F(){E(),g=30,w=!0,I=setInterval(()=>{g--,g<=0&&(E(),alert("💀 TIME EXPIRED! Device is being wiped clean NOW!"),document.getElementById("status").textContent="💀 DEVICE WIPED - Failed to return to boundary in time",f=!1,r.setStyle({color:"#000000",fillColor:"#000000",fillOpacity:.5}))},1e3)}function E(){I&&(clearInterval(I),I=null),w=null,g=30}function O(e,n){const a=e.lat,l=e.lng;let t=!1;for(let i=0,s=n.length-1;i<n.length;s=i++){const D=n[i][0],b=n[i][1],T=n[s][0],x=n[s][1];b>l!=x>l&&a<(T-D)*(l-b)/(x-b)+D&&(t=!t)}return t}function B(e,n){if(!o||o.length<3)return 0;let a=1/0;const l=L.latLng(e,n);for(let t=0;t<o.length;t++){const i=L.latLng(o[t][0],o[t][1]);L.latLng(o[(t+1)%o.length][0],o[(t+1)%o.length][1]);const s=l.distanceTo(i);a=Math.min(a,s)}return a}function $(){E(),p=!1,f=!1,o=[],m=null,c.eachLayer(e=>{(e instanceof L.Polygon||e instanceof L.CircleMarker||e instanceof L.Polyline)&&c.removeLayer(e)}),r=null,document.getElementById("btnDraw").disabled=!1,document.getElementById("btnFinish").disabled=!0,document.getElementById("btnMonitor").disabled=!0,document.getElementById("status").textContent='Click "Start Drawing" to create a boundary'}
