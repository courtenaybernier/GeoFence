<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoFence App</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; }
        #header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; }
        h1 { font-size: 24px; margin-bottom: 10px; }
        #coords { font-size: 14px; opacity: 0.9; }
        #map { flex: 1; z-index: 0; }
        #controls { padding: 15px; background: white; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); display: flex; gap: 10px; flex-wrap: wrap; }
        button { flex: 1; min-width: 120px; padding: 12px 20px; font-size: 14px; font-weight: 600; border: none; border-radius: 6px; cursor: pointer; }
        .btn-draw { background: #667eea; color: white; }
        .btn-finish { background: #4caf50; color: white; }
        .btn-monitor { background: #f44336; color: white; }
        .btn-reset { background: #9e9e9e; color: white; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #status { width: 100%; padding: 10px; background: #e3f2fd; color: #1976d2; border-radius: 6px; font-size: 13px; text-align: center; }
    </style>
</head>
<body>
    <div id="header">
        <h1>üó∫Ô∏è GeoFence App</h1>
        <div id="coords">Waiting for GPS location...</div>
    </div>
    <div id="map"></div>
    <div id="controls">
        <div id="status">Click "Start Drawing" to create a boundary</div>
        <button class="btn-draw" id="btnDraw">Start Drawing</button>
        <button class="btn-finish" id="btnFinish" disabled>Finish Drawing</button>
        <button class="btn-monitor" id="btnMonitor" disabled>Start Monitoring</button>
        <button class="btn-reset" id="btnReset">Reset</button>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
// GeoFence App
let map, marker, polygon, drawnPoints = [], isDrawing = false, isMonitoring = false, monitorInterval = null;

// Wait for Leaflet to load
function initApp() {
  if (typeof L === 'undefined') {
    setTimeout(initApp, 100);
    return;
  }
  
  initializeMap();
  requestLocation();
  setInterval(requestLocation, 5000);
  
  document.getElementById('btnDraw').onclick = startDrawing;
  document.getElementById('btnFinish').onclick = finishDrawing;
  document.getElementById('btnMonitor').onclick = startMonitoring;
  document.getElementById('btnReset').onclick = resetApp;
}

document.addEventListener('DOMContentLoaded', initApp);

function initializeMap() {
  map = L.map('map').setView([37.7749, -122.4194], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);
}

function requestLocation() {
  if (!navigator.geolocation) {
    updateStatus('Geolocation not supported', 'error');
    return;
  }
  
  navigator.geolocation.getCurrentPosition(
    (position) => {
      const { latitude, longitude } = position.coords;
      updateCoords(latitude, longitude);
      updateMapCenter(latitude, longitude);
      if (isMonitoring) checkBoundary(latitude, longitude);
    },
    (error) => {
      updateStatus(`Location error: ${error.message}`, 'error');
    },
    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
  );
}

function updateCoords(lat, lng) {
  document.getElementById('coords').textContent = `üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
}

function updateMapCenter(lat, lng) {
  if (!marker) {
    marker = L.marker([lat, lng]).addTo(map);
  } else {
    marker.setLatLng([lat, lng]);
  }
  map.setView([lat, lng], map.getZoom());
}

function updateStatus(message, type = 'info') {
  const status = document.getElementById('status');
  status.textContent = message;
  status.style.background = type === 'error' ? '#ffebee' : type === 'success' ? '#e8f5e9' : '#e3f2fd';
  status.style.color = type === 'error' ? '#c62828' : type === 'success' ? '#2e7d32' : '#1976d2';
}

function startDrawing() {
  isDrawing = true;
  drawnPoints = [];
  if (polygon) map.removeLayer(polygon);
  
  updateStatus('Click on the map to draw boundary points', 'info');
  document.getElementById('btnDraw').disabled = true;
  document.getElementById('btnFinish').disabled = false;
  
  map.on('click', handleMapClick);
}

function handleMapClick(e) {
  if (!isDrawing) return;
  
  drawnPoints.push([e.latlng.lat, e.latlng.lng]);
  L.circleMarker(e.latlng, { radius: 5, color: '#667eea' }).addTo(map);
  
  if (drawnPoints.length > 1) {
    if (polygon) map.removeLayer(polygon);
    polygon = L.polygon(drawnPoints, { color: '#667eea', fillOpacity: 0.2 }).addTo(map);
  }
  
  updateStatus(`${drawnPoints.length} points drawn. Need at least 3 to finish.`, 'info');
}

function finishDrawing() {
  if (drawnPoints.length < 3) {
    updateStatus('Need at least 3 points to create a boundary', 'error');
    return;
  }
  
  isDrawing = false;
  map.off('click', handleMapClick);
  
  updateStatus(`Boundary created with ${drawnPoints.length} points`, 'success');
  document.getElementById('btnDraw').disabled = false;
  document.getElementById('btnFinish').disabled = true;
  document.getElementById('btnMonitor').disabled = false;
}

function startMonitoring() {
  if (!polygon) {
    updateStatus('Please create a boundary first', 'error');
    return;
  }
  
  isMonitoring = !isMonitoring;
  const btn = document.getElementById('btnMonitor');
  
  if (isMonitoring) {
    btn.textContent = 'Stop Monitoring';
    btn.style.background = '#ff9800';
    updateStatus('üîç Monitoring active - checking location every 2 seconds', 'success');
    
    monitorInterval = setInterval(() => {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          checkBoundary(position.coords.latitude, position.coords.longitude);
        },
        null,
        { enableHighAccuracy: true }
      );
    }, 2000);
  } else {
    btn.textContent = 'Start Monitoring';
    btn.style.background = '#f44336';
    updateStatus('Monitoring stopped', 'info');
    if (monitorInterval) clearInterval(monitorInterval);
  }
}

function checkBoundary(lat, lng) {
  if (!polygon || !isMonitoring) return;
  
  const isInside = isPointInPolygon([lat, lng], drawnPoints);
  
  if (!isInside) {
    alert('‚ö†Ô∏è Your device has left the boundary and will be wiped clean!');
    updateStatus('üö® ALERT: Device left boundary!', 'error');
  } else {
    updateStatus('‚úÖ Inside boundary - monitoring...', 'success');
  }
}

function isPointInPolygon(point, polygon) {
  let inside = false;
  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i][0], yi = polygon[i][1];
    const xj = polygon[j][0], yj = polygon[j][1];
    
    const intersect = ((yi > point[1]) !== (yj > point[1]))
        && (point[0] < (xj - xi) * (point[1] - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

function resetApp() {
  isDrawing = false;
  isMonitoring = false;
  drawnPoints = [];
  
  if (polygon) map.removeLayer(polygon);
  if (monitorInterval) clearInterval(monitorInterval);
  
  map.eachLayer((layer) => {
    if (layer instanceof L.CircleMarker) map.removeLayer(layer);
  });
  
  map.off('click', handleMapClick);
  
  document.getElementById('btnDraw').disabled = false;
  document.getElementById('btnFinish').disabled = true;
  document.getElementById('btnMonitor').disabled = true;
  document.getElementById('btnMonitor').textContent = 'Start Monitoring';
  document.getElementById('btnMonitor').style.background = '#f44336';
  
  updateStatus('App reset. Click "Start Drawing" to create a new boundary', 'info');
}
    </script>
</body>
</html>
